<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    </head>
<body>

<section class="container">
    <header>
        <h2 class="title">Proposta de Candidato</h2>
    </header>

    <div class="field">
        <label class="label">Nome</label>
        <div class="control">
            <input class="input" type="text" placeholder="Nome">
        </div>
    </div>

    <div class="field">
        <label class="label">CPF</label>
        <div class="control">
            <input id="CampoCPF" class="input" type="text" placeholder="CPF" onchange="ValidaCPF();">
        </div>
    </div>

    <div class="field">
        <label class="label">Email</label>
        <div class="control">
            <input id="CampoEmail" class="input" type="email" placeholder="Email" onchange="ValidaEmail();">
        </div>
    </div>

    <div class="field">
        <label class="label">Telefone</label>
        <div class="control">
            <input id="CampoTelefone" class="input" type="text" placeholder="Telefone" onchange="ValidaTelefone();">
        </div>
    </div>

    <div class="field">
        <label class="label">Habilitação</label>
        <div class="control">
            <input id="CampoHabilitacao" type="checkbox" onchange="AcionaCategoria();">
        </div>
    </div>

    <div class="field">
        <label class="label">Categoria</label>
        <div class="control">
            <input id="CampoHabilitacaoCategoria" class="input" type="text" placeholder="Categoria">
        </div>
    </div>

    <div class="field">
        <label class="label">Lingua Estrangeira</label>
        <div class="control">
            <div class="select">
                <select>
                    <option>Inglês</option>
                    <option>Espanhol</option>
                    <option>Francês</option>
                </select>
            </div>
        </div>
    </div>

    <div class="field">
        <label class="label">Estado</label>
        <div class="control">
            <div class="select">
                <select id="SelectEstados" onchange="CarregaCidades();">
                </select>
            </div>
        </div>
    </div>

    <div class="field">
        <label class="label">Cidade</label>
        <div class="control">
            <div class="select">
                <select id="SelectCidades">
                </select>
            </div>
        </div>
    </div>

    <div class="field">
        <label class="label">CEP</label>
        <div class="control">
            <input id="CampoCEP" class="input" type="text" placeholder="CEP" onchange="ValidaCEP();">
        </div>
    </div>

    <div class="field">
        <label class="label">Logradouro</label>
        <div class="control">
            <input id="CampoLogradouro" class="input" type="text" placeholder="Logradouro">
        </div>
    </div>

    <div class="field">
        <label class="label">Número</label>
        <div class="control">
            <input id="CampoNumero" class="input" type="number" min="0" step="1" placeholder="Número"
                onchange="ValidaNumero();">
        </div>
    </div>

    <div class="field">
        <label class="label">Complemento</label>
        <div class="control">
            <input id="CampoComplemento" class="input" type="text" placeholder="Complemento">
        </div>
    </div>

    <div class="field">
        <label class="label">Cargo</label>
        <div class="control">
            <div class="select">
                <select>
                    <option>Analista de Sistemas I</option>
                    <option>Analista de Sistemas II</option>
                    <option>Analista de Sistemas III</option>
                    <option>Analista de Sistemas IV</option>
                    <option>Analista de Sistemas V</option>
                </select>
            </div>
        </div>
    </div>

    <div class="field">
        <label class="label">Salário Proposto</label>
        <div class="control">
            <input id="CampoSalario" class="input" type="text" placeholder="Salário" onchange="ValidaSalario();">
        </div>
    </div>

</section>

<section class="container">
    <header>
        <h2 class="title">Tabela de Horário de Trabalho</h2>
    </header>

    <table>
        <tr>
            <th>Dia da Semana</th>
            <th>Hora Início</th>
            <th>Hora Fim</th>
            <th>Tempo de Descanso (h)</th>
            <th>Carga Horária (h)</th>
        </tr>
        <tr>
            <td>Segunda</td>
            <td><input class="HorarioInicio" onchange="TrataDia(this);"></td>
            <td><input class="HorarioFim" onchange="TrataDia(this);"></td>
            <td><input class="HorarioDescanso" onchange="TrataDia(this);"></td>
            <td><input class="HorarioCarga" readonly></td>
        </tr>
        <tr>
            <td>Terça</td>
            <td><input class="HorarioInicio" onchange="TrataDia(this);"></td>
            <td><input class="HorarioFim" onchange="TrataDia(this);"></td>
            <td><input class="HorarioDescanso" onchange="TrataDia(this);"></td>
            <td><input class="HorarioCarga" readonly></td>
        </tr>
        <tr>
            <td>Quarta</td>
            <td><input class="HorarioInicio" onchange="TrataDia(this);"></td>
            <td><input class="HorarioFim" onchange="TrataDia(this);"></td>
            <td><input class="HorarioDescanso" onchange="TrataDia(this);"></td>
            <td><input class="HorarioCarga" readonly></td>
        </tr>
        <tr>
            <td>Quinta</td>
            <td><input class="HorarioInicio" onchange="TrataDia(this);"></td>
            <td><input class="HorarioFim" onchange="TrataDia(this);"></td>
            <td><input class="HorarioDescanso" onchange="TrataDia(this);"></td>
            <td><input class="HorarioCarga" readonly></td>
        </tr>
        <tr>
            <td>Sexta</td>
            <td><input class="HorarioInicio" onchange="TrataDia(this);"></td>
            <td><input class="HorarioFim" onchange="TrataDia(this);"></td>
            <td><input class="HorarioDescanso" onchange="TrataDia(this);"></td>
            <td><input class="HorarioCarga" readonly></td>
        </tr>
        <tr>
            <td colspan="4">Carga Horária Semanal</td>
            <td><input id="HorarioCargaSemanal" readonly></td>
        </tr>
    </table>
</section>
    </body>
    <script>
    /**
     * Formulário de Proposta
     **/

    window.onload = (evt) => {
        CarregaEstados();
    }

    function CarregaCidades() {
        const selectEstados = document.getElementById("SelectEstados");
        const selectCidades = document.getElementById("SelectCidades");
        selectCidades.innerHTML = '';
        const unidade = selectEstados.value;
        fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${unidade}/distritos`)
            .then(response => response.json())
            .then(data => {
                data.map(el => {
                    let opt = document.createElement("option");
                    opt.appendChild(document.createTextNode(el.nome));
                    selectCidades.appendChild(opt);
                });
            });
    }

    function CarregaEstados() {
        const selectEstados = document.getElementById("SelectEstados");
        fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados')
            .then(response => response.json())
            .then(data => {
                data.map(el => {
                    let opt = document.createElement("option");
                    opt.appendChild(document.createTextNode(el.nome));
                    opt.value = el.sigla;
                    selectEstados.appendChild(opt);
                });
            });
    }

    function AcionaCategoria() {
        let campoHabilitacao = document.getElementById("CampoHabilitacao");
        let campoCategoria = document.getElementById("CampoHabilitacaoCategoria");
        if (campoHabilitacao.checked) {
            campoCategoria.disabled = false;
        } else {
            campoCategoria.value = "";
            campoCategoria.disabled = true;
        }
    }

    function CarregaLogradouro() {
        const campoCEP = document.getElementById("CampoCEP");
        const campoLogradouro = document.getElementById("CampoLogradouro");
        const cep = campoCEP.value.replace("-", "");
        fetch(`http://viacep.com.br/ws/${cep}/json/`)
            .then(resp => resp.json())
            .then(data => {
                campoLogradouro.value = data.logradouro;
            });
    }

    function ValidaSalario() {
        const campoSalario = document.getElementById("CampoSalario");
        if (!TestaSalario(campoSalario.value)) {
            campoSalario.classList.add("is-danger");
        } else {
            campoSalario.classList.remove("is-danger");
        }
    }

    function TestaSalario(salario) {
        const regex = /[0-9.]+,[0-9]{2}/;
        return regex.test(salario);
    }

    function ValidaNumero() {
        const campoNumero = document.getElementById("CampoNumero");
        if (!TestaNumero(campoNumero.value)) {
            campoNumero.classList.add("is-danger");
        } else {
            campoNumero.classList.remove("is-danger");
        }
    }

    function TestaNumero(numero) {
        const regex = /\d+/;
        return regex.test(numero);
    }

    function ValidaCEP() {
        const campoCEP = document.getElementById("CampoCEP");
        const campoLogradouro = document.getElementById("CampoLogradouro");
        if (!TestaCEP(campoCEP.value)) {
            campoCEP.classList.add("is-danger");
            campoLogradouro.value = '';
        } else {
            campoCEP.classList.remove("is-danger");
            CarregaLogradouro();
        }
    }

    function TestaCEP(cep) {
        const regex = /\d{5}-?\d{3}/;
        return regex.test(cep);
    }

    function ValidaTelefone() {
        let campoTelefone = document.getElementById("CampoTelefone");
        if (!TestaTelefone(campoTelefone.value)) {
            campoTelefone.classList.add("is-danger");
        } else {
            campoTelefone.classList.remove("is-danger");
        }
    }

    function TestaTelefone(telefone) {
        // https://pt.stackoverflow.com/a/189214
        let regex =  /\(\d{2}\)\s?\d{4,5}-?\d{4}/g;
        return regex.test(telefone);
    }

    function ValidaEmail() {
        let campoEmail = document.getElementById("CampoEmail");
        if (!TestaEmail(campoEmail)) {
            campoEmail.classList.add("is-danger");
        }  else {
            campoEmail.classList.remove("is-danger");
        }
    }

    // https://www.devmedia.com.br/validando-e-mail-em-inputs-html-com-javascript/26427
    function TestaEmail(field) {
        let usuario = field.value.substring(0, field.value.indexOf("@"));
        let dominio = field.value.substring(field.value.indexOf("@") + 1, field.value.length);

        if ((usuario.length >= 1) &&
            (dominio.length >= 3) &&
            (usuario.search("@") == -1) &&
            (dominio.search("@") == -1) &&
            (usuario.search(" ") == -1) &&
            (dominio.search(" ") == -1) &&
            (dominio.search(".") != -1) &&
            (dominio.indexOf(".") >= 1) &&
            (dominio.lastIndexOf(".") < dominio.length - 1)) {
            return true;
        }
        else {
            return false;
        }
    }

        function ValidaCPF() {
            let campoCpf = document.getElementById("CampoCPF");
            if (!TestaCPF(campoCpf.value)) {
                campoCpf.classList.add("is-danger");
            } else {
                campoCpf.classList.remove("is-danger");
            }
        }
        // https://www.devmedia.com.br/validar-cpf-com-javascript/23916
        function TestaCPF(strCPF) {
                var Soma;
                var Resto;
                Soma = 0;
                if (strCPF == "00000000000") return false;

                for (i = 1; i <= 9; i++) Soma = Soma + parseInt(strCPF.substring(i - 1, i)) * (11 - i);
                Resto = (Soma * 10) % 11;

                if ((Resto == 10) || (Resto == 11)) Resto = 0;
                if (Resto != parseInt(strCPF.substring(9, 10))) return false;

                Soma = 0;
                for (i = 1; i <= 10; i++) Soma = Soma + parseInt(strCPF.substring(i - 1, i)) * (12 - i);
                Resto = (Soma * 10) % 11;

                if ((Resto == 10) || (Resto == 11)) Resto = 0;
                if (Resto != parseInt(strCPF.substring(10, 11))) return false;
                return true;
            }
    </script>
    <script>
        /**
         * Tabela de Horário
         **/
        function TrataDia(el) {
            const elHorarioInicio = el.parentNode.parentNode.getElementsByClassName("HorarioInicio")[0];
            const elHorarioFim = el.parentNode.parentNode.getElementsByClassName("HorarioFim")[0];
            const elHorarioDescanso = el.parentNode.parentNode.getElementsByClassName("HorarioDescanso")[0];
            const elHorarioCarga = el.parentNode.parentNode.getElementsByClassName("HorarioCarga")[0];

            if (!ValidaHora(elHorarioInicio.value) || !ValidaHora(elHorarioFim.value) ||
                    !ValidaDescanso(elHorarioInicio.value, elHorarioFim.value, elHorarioDescanso.value)) {
                elHorarioInicio.style.backgroundColor = "salmon";
                elHorarioFim.style.backgroundColor = "salmon";
                elHorarioDescanso.style.backgroundColor = "salmon";
                elHorarioCarga.value = "";
            } else {
                elHorarioInicio.style.backgroundColor = "";
                elHorarioFim.style.backgroundColor = "";
                elHorarioDescanso.style.backgroundColor = "";
                elHorarioCarga.value = (
                    (ConverteHora(elHorarioFim.value) - ConverteHora(elHorarioInicio.value) - elHorarioDescanso.value * 60) / 60
                );
                AtualizaCargaSemanal();
            }

        }

        function AtualizaCargaSemanal() {
            const elHorarioCargaSemanal = document.getElementById("HorarioCargaSemanal");
            let carga = 0;
            for (el of document.getElementsByClassName("HorarioCarga")) {
                try {
                    carga += parseFloat(el.value);
                } catch {
                    // pass
                }
            }
            elHorarioCargaSemanal.value = carga;
        }

        function ConverteHora(hora_) {
            let [hora, minuto] = hora_.split(":");
            hora = parseInt(hora);
            minuto = parseInt(minuto);
            return hora * 60 + minuto;
        }

        function ValidaHora(hora_) {
            const regex = /\d{2}:\d{2}/;
            if (!regex.test(hora_)) {
                return false;
            }
            try {
                let [hora, minuto] = hora_.split(":");
                hora = parseInt(hora);
                minuto = parseInt(minuto);
                return hora >= 0 && hora <= 23 && minuto >= 0 && minuto <= 59;
            } catch {
                return false;
            }
        }

        function ValidaDescanso(horaInicio, horaFim, descanso) {
            try {
                const minutosInicio = ConverteHora(horaInicio);
                const minutosFim = ConverteHora(horaFim);
                if (minutosFim <= minutosInicio) {
                    return false;
                }
                const horasDescanso = parseInt(descanso) * 60;
                const horasTrabalhadas = minutosFim - minutosInicio;
                if (horasTrabalhadas - horasDescanso < 0) {
                    return false;
                }
                if (horasTrabalhadas - horasDescanso >= 10*60) {
                    alert("Número de horas trabalhadas excede 10 horas.")
                    return false;
                }
            } catch {
                return false;
            }
            return true;
        }
    </script>
</html>